import * as request from 'request';

import { IErrorReportingService, createVersionCheckError } from '@glimpse/glimpse-common';

import { IServer } from '../IServer';
import { IResource } from './IResource';

export class Resource implements IResource {
    private errorReportingService: IErrorReportingService;

    public name = 'version-check';
    public uriTemplate = '{?currentVersion}';
    public type = 'client';

    public constructor(server: IServer) {
        this.errorReportingService = server.providers.errorReportingService;
    }

    public invoke(req, res) {
        const that = this;
        const url = 'https://registry.npmjs.org/@glimpse%2Fglimpse';
        request.get({ url: url, json: true }, function(err, resp, body) {
            if (!err) {
                // forward body through as our response
                res.json(body);
            }
            else {
                // make sure we report the error
                that.errorReportingService.reportError(createVersionCheckError(err));

                // still need to request
                res.status(500).send('Verion check failed: ' + err);
            }
        });
    }
}
